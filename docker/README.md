A `Dockerfile` is provided here to run `incasem`. Similar to the Colab notebook, this is the full version of `incasem` but does not have experiment tracking and databaase management using `sacred` and `mongodb`, respectively.
If it is desirable to store and manage experiments using those utilities, refer to the main `README` for installation instructions.
This version, like the Colab notebook will use a very simple experiment tracking & cataloging approach, by storing model metadata in a directory called `mock_db` and updating a ledger file, to emulate a database.     

The below instructions are for a Linux installation of Docker. You can also use Docker on Mac and Windows, and the instructions below will be largely applicable to those,
but Mac/Windows-specific commands will not be covered.

### Pre-Requisites
1. System with an NVIDIA GPU
2. Docker installation
3. NVIDIA Container Toolkit installation

### Build & Run Container
1. Navigate to the `docker` directory
2. Build the container
 ```bash
   docker build -t incasem_container .
   ```  
3. When building is complete, run the container. It is necessary to specify that the GPUs should be used by the container
   ```bash
   docker run --gpus all -it incasem_container
   ```

### Operations within Container
Once in the container, you can navigate to `src/incasem` and run `conda activate incasem`.     
From here you can download data, train models, and run commands as specified in the `README`    

### Mounting Local Drives
If you have `zarr` or `TIFF` data on a local volume, it will be time-consuming and inefficient to copy the data when building
the container, and if the data changes, it will not be reflected in the container. To mount a local drive with your data so that it is visible to the container,
when you run the container add the following:     

`-v /path/to/your/local/volume:/workspace/path/to/container/location`       

A complete `run` command with this option looks like this:
```bash
docker run -v /home/my_local_drive:/workspace/src/data_from_local --gpus all -it incasem_container
```

### Viewing Data with `neuroglancer`
When you run `neuroglancer` to view data from within the container, `neuroglancer` serves it on a port local to the Docker container.  If 
you click the link, or paste it into the browser of your local machine, it will not work.     
When running the container, you must forward a local port and map it to a Docker container port. This is done with the 
following command line option:    

`-p local_port_num:docker_port_num`      

The Docker neuroglancer instance has been programmed to run on port 9999. Below is a complete `run` command, mapping the Docker port 9999
to local port 8080.     
```bash
docker run -p 8080:9999 -v /local/drive:/workspace/docker_drive --gpus all -it incasem_container
```
You can now copy the link generated by `neuroglancer` to your local machine and replace the `<container_id>` and `PORT` from the link, which will look like this: `http://f8c7e229e260:9999/`, with
`http://localhost:8080`, with the rest of the link as generated by `neuroglancer`     

#### Other `neuroglancer` instructions
After running the above and activating the `incasem` `conda` environment, you must do the following to use neuroglancer (specified on `main` `README`):     
```bash
pip install git+https://github.com/kirchhausenlab/funlib.show.neuroglancer.git@incasem_scripts#egg=funlib.show.neuroglancer
```
